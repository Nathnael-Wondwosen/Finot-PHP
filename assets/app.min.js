let currentView = 'all';let currentTable = 'students';let currentStudentId = null;let hasUnsavedChanges = false;document.addEventListener("DOMContentLoaded", function() {initializeAdvancedFeatures();setupEventListeners();const urlParams = new URLSearchParams(window.location.search);currentView = urlParams.get('view') || 'all';currentTable = (currentView === 'instrument') ? 'instruments' : 'students';});function initializeAdvancedFeatures() {setupSearchAutocomplete();initializeTooltips();setupKeyboardShortcuts();initializeTableSorting();}function setupEventListeners() {const filterForm = document.getElementById("filter-form");if (filterForm) {filterForm.addEventListener("change", function(e) {if (e.target.type === "select-one" || e.target.type === "date") {setTimeout(() => filterForm.submit(), 300);}});}}function setupSearchAutocomplete() {const searchInput = document.getElementById("search");if (searchInput) {let searchTimeout;searchInput.addEventListener("input", function(e) {clearTimeout(searchTimeout);searchTimeout = setTimeout(() => {if (e.target.value.length >= 2) {console.log("Search suggestions for:", e.target.value);}}, 300);});}}function setupKeyboardShortcuts() {document.addEventListener("keydown", function(e) {if ((e.ctrlKey || e.metaKey) && e.key === "a" && !e.target.matches("input, textarea")) {e.preventDefault();selectAll();}if (e.key === "Escape") {selectNone();closeAllModals();}if ((e.ctrlKey || e.metaKey) && e.key === "f") {e.preventDefault();document.getElementById("search")?.focus();}});}function initializeTableSorting() {document.querySelectorAll("[data-sort]").forEach(header => {header.addEventListener("click", function() {const sortBy = this.dataset.sort;const currentSort = new URLSearchParams(window.location.search).get("sort");const currentOrder = new URLSearchParams(window.location.search).get("order") || "asc";let newOrder = "asc";if (currentSort === sortBy && currentOrder === "asc") {newOrder = "desc";}const url = new URL(window.location);url.searchParams.set("sort", sortBy);url.searchParams.set("order", newOrder);window.location.href = url.toString();});});}window.viewStudentDetails = function(studentId, table = "students") {window.currentStudentId = studentId;window.currentTable = table;const modal = document.getElementById("student-details-modal");const content = document.getElementById("modal-content");if (!modal || !content) {console.error("Modal elements not found");return;}content.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div></div>';modal.classList.remove("hidden");fetch(window.location.href, {method: "POST",headers: { "Content-Type": "application/x-www-form-urlencoded" },body: 'action=get_student_details&student_id=' + studentId + '&table=' + table}).then(response => response.json()).then(data => {if (data.success) {window.displayStudentDetails(data.student);} else {content.innerHTML = '<div class="text-center py-8"><i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i><p class="text-gray-600 dark:text-gray-400">' + data.message + '</p></div>';}}).catch(error => {console.error("Error:", error);content.innerHTML = '<div class="text-center py-8"><i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i><p class="text-gray-600 dark:text-gray-400">Error loading student details</p></div>';});};window.editStudent = function(studentId, table = "students") {fetch(window.location.href, {method: "POST",headers: { "Content-Type": "application/x-www-form-urlencoded" },body: 'action=get_student_details&student_id=' + studentId + '&table=' + table}).then(response => response.json()).then(data => {if (data.success) {window.currentEditingStudent = data.student;window.currentEditingTable = table;window.openEditDrawer(data.student, table);} else {window.showToast(data.message || "Error loading student data", "error");}}).catch(error => {console.error("Error:", error);window.showToast("Error loading student data", "error");});};window.deleteStudent = function(studentId, table = "students") {if (!confirm("Are you sure you want to delete this student? This action cannot be undone.")) {return;}fetch(window.location.href, {method: "POST",headers: { "Content-Type": "application/x-www-form-urlencoded" },body: 'action=delete_student&student_id=' + studentId + '&table=' + table}).then(response => response.json()).then(data => {if (data.success) {const row = document.querySelector('[data-student-id="' + studentId + '"]')?.closest("tr");if (row) { row.remove(); }window.showToast(data.message, "success");setTimeout(() => {window.location.reload();}, 1000);} else {window.showToast(data.message, "error");}}).catch(error => {console.error("Error:", error);window.showToast("Error deleting student", "error");});};window.showToast = function(message, type) {type = type || 'info';document.querySelectorAll('.toast').forEach(toast => toast.remove());const toast = document.createElement('div');toast.className = 'toast fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300';const colors = {success: 'bg-green-500 text-white',error: 'bg-red-500 text-white',warning: 'bg-yellow-500 text-white',info: 'bg-blue-500 text-white'};const icons = {success: 'fa-check-circle',error: 'fa-exclamation-circle',warning: 'fa-exclamation-triangle',info: 'fa-info-circle'};toast.className += ' ' + (colors[type] || colors.info);toast.innerHTML = '<div class="flex items-center space-x-2"><i class="fas ' + (icons[type] || icons.info) + '"></i><span>' + message + '</span></div>';document.body.appendChild(toast);setTimeout(function() {toast.classList.remove('translate-x-full');}, 100);setTimeout(function() {toast.classList.add('translate-x-full');setTimeout(function() { toast.remove(); }, 300);}, 3000);};window.displayStudentDetails = function(student) {const content = document.getElementById("modal-content");if (!content) return;let html = '<div class="hidden print:block mb-4">' +'<div class="text-center">' +'<h1 class="text-xl font-bold">Student Profile Report</h1>' +'<h2 class="text-lg">' + (student.full_name || "N/A") + '</h2>' +'<p class="text-sm">Generated: ' + new Date().toLocaleDateString() + '</p>' +'</div><hr class="my-4">' +'</div>';html += '<div class="space-y-6">';html += '<div class="flex items-start space-x-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 rounded-lg">';if (student.photo_path) {html += '<img src="' + student.photo_path + '" class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg">';} else {html += '<div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center border-4 border-white shadow-lg">' +'<i class="fas fa-user text-white text-2xl"></i>' +'</div>';}html += '<div class="flex-1">' +'<h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">' + (student.full_name || "N/A") + '</h3>';if (student.christian_name) {html += '<p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Christian Name: ' + student.christian_name + '</p>';}html += '<div class="flex flex-wrap gap-2 mt-2">' +'<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Grade: ' + (student.current_grade || "N/A") + '</span>';if (student.gender) {html += '<span class="px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded-full">' + student.gender + '</span>';}if (student.instrument) {html += '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">' + student.instrument + '</span>';}html += '</div></div></div>';html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';html += '<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border p-4">' +'<h4 class="text-lg font-semibold mb-4">Personal Information</h4>' +'<div class="space-y-2">';if (student.full_name) html += '<p><strong>Full Name:</strong> ' + student.full_name + '</p>';if (student.phone_number) html += '<p><strong>Phone:</strong> ' + student.phone_number + '</p>';if (student.birth_date) html += '<p><strong>Birth Date:</strong> ' + student.birth_date + '</p>';if (student.sub_city) html += '<p><strong>Sub City:</strong> ' + student.sub_city + '</p>';if (student.district) html += '<p><strong>District:</strong> ' + student.district + '</p>';html += '</div></div>';html += '<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border p-4">' +'<h4 class="text-lg font-semibold mb-4">Academic Information</h4>' +'<div class="space-y-2">';if (student.regular_school_name) html += '<p><strong>School:</strong> ' + student.regular_school_name + '</p>';if (student.education_level) html += '<p><strong>Education Level:</strong> ' + student.education_level + '</p>';if (student.field_of_study) html += '<p><strong>Field of Study:</strong> ' + student.field_of_study + '</p>';html += '</div></div></div>';if (student.father_full_name || student.mother_full_name || student.guardian_full_name) {html += '<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border p-4">' +'<h4 class="text-lg font-semibold mb-4">Family Information</h4>' +'<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';if (student.father_full_name) {html += '<div><h5 class="font-medium">Father</h5>' +'<p class="text-sm">Name: ' + student.father_full_name + '</p>';if (student.father_phone) html += '<p class="text-sm">Phone: ' + student.father_phone + '</p>';if (student.father_occupation) html += '<p class="text-sm">Occupation: ' + student.father_occupation + '</p>';html += '</div>';}if (student.mother_full_name) {html += '<div><h5 class="font-medium">Mother</h5>' +'<p class="text-sm">Name: ' + student.mother_full_name + '</p>';if (student.mother_phone) html += '<p class="text-sm">Phone: ' + student.mother_phone + '</p>';if (student.mother_occupation) html += '<p class="text-sm">Occupation: ' + student.mother_occupation + '</p>';html += '</div>';}if (student.guardian_full_name) {html += '<div><h5 class="font-medium">Guardian</h5>' +'<p class="text-sm">Name: ' + student.guardian_full_name + '</p>';if (student.guardian_phone) html += '<p class="text-sm">Phone: ' + student.guardian_phone + '</p>';if (student.guardian_occupation) html += '<p class="text-sm">Occupation: ' + student.guardian_occupation + '</p>';html += '</div>';}html += '</div></div>';}if (student.emergency_name || student.emergency_phone) {html += '<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border p-4">' +'<h4 class="text-lg font-semibold mb-4">Emergency Contact</h4>' +'<div class="space-y-2">';if (student.emergency_name) html += '<p><strong>Contact Name:</strong> ' + student.emergency_name + '</p>';if (student.emergency_phone) html += '<p><strong>Phone:</strong> ' + student.emergency_phone + '</p>';if (student.emergency_alt_phone) html += '<p><strong>Alt Phone:</strong> ' + student.emergency_alt_phone + '</p>';if (student.emergency_address) html += '<p><strong>Address:</strong> ' + student.emergency_address + '</p>';html += '</div></div>';}let hasAdditionalInfo = student.special_interests || student.siblings_in_school || student.physical_disability || student.weak_side;if (hasAdditionalInfo) {html += '<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border p-4">' +'<h4 class="text-lg font-semibold mb-4">Additional Information</h4>' +'<div class="space-y-2">';if (student.special_interests) html += '<p><strong>Special Interests:</strong> ' + student.special_interests + '</p>';if (student.siblings_in_school) html += '<p><strong>Siblings in School:</strong> ' + student.siblings_in_school + '</p>';if (student.physical_disability) html += '<p><strong>Physical Disability:</strong> ' + student.physical_disability + '</p>';if (student.weak_side) html += '<p><strong>Weak Side:</strong> ' + student.weak_side + '</p>';html += '</div></div>';}html += '<div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">' +'<h4 class="text-lg font-semibold mb-4">Registration Information</h4>' +'<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';if (student.created_at) {html += '<p><strong>Registered:</strong> ' + new Date(student.created_at).toLocaleDateString() + '</p>';}if (student.id) {html += '<p><strong>Student ID:</strong> ' + student.id + '</p>';}html += '</div></div></div>';content.innerHTML = html;};function viewStudentDetails(studentId, table = "students") {return window.viewStudentDetails(studentId, table);}function displayStudentDetails(student) {return window.displayStudentDetails(student);}function toggleFlag(studentId, table = "students") {const button = document.querySelector('[data-flag-btn="' + studentId + '"]');if (button) {button.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';}fetch(window.location.href, {method: "POST",headers: { "Content-Type": "application/x-www-form-urlencoded" },body: 'action=toggle_flag&student_id=' + studentId + '&table=' + table}).then(response => response.json()).then(data => {if (data.success) {updateFlagButton(studentId, data.flagged);showToast(data.message, "success");} else {showToast(data.message, "error");}}).catch(error => {console.error("Error:", error);showToast("Error updating flag status", "error");}).finally(() => {if (button) {button.innerHTML = '<i class="fas fa-flag text-sm"></i>';}});}function updateFlagButton(studentId, flagged) {const button = document.querySelector('[data-flag-btn="' + studentId + '"]');if (button) {button.title = flagged ? "Unflag" : "Flag";if (flagged) {button.classList.add("text-red-600", "dark:text-red-400", "bg-red-100", "dark:bg-red-900/50");button.classList.remove("text-gray-400", "dark:text-gray-500", "hover:bg-gray-100", "dark:hover:bg-gray-700");} else {button.classList.remove("text-red-600", "dark:text-red-400", "bg-red-100", "dark:bg-red-900/50");button.classList.add("text-gray-400", "dark:text-gray-500", "hover:bg-gray-100", "dark:hover:bg-gray-700");}}}function editCurrentStudent() {if (currentStudentId) {editStudent(currentStudentId, currentTable);} else {showToast("No student selected for editing", "warning");}}function editStudent(studentId, table = "students") {return window.editStudent(studentId, table);}function deleteStudent(studentId, table = "students") {return window.deleteStudent(studentId, table);}function clearSearch() {document.getElementById("search").value = "";document.getElementById("filter-form").submit();}function applyQuickFilter(type) {const url = new URL(window.location);if (type === "flagged") {url.searchParams.set("status", "flagged");}window.location.href = url.toString();}function exportData() {const selectedColumns = [];document.querySelectorAll('.column-checkbox:checked').forEach(checkbox => {selectedColumns.push(checkbox.value);});const url = new URL(window.location);url.pathname = url.pathname.replace('students.php', 'export_students.php');if (selectedColumns.length > 0) {url.searchParams.set('columns', selectedColumns.join(','));}window.open(url.toString(), '_blank');showToast('Export started. Check your downloads folder.', 'info');}function closeStudentDetailsModal() {document.getElementById("student-details-modal").classList.add("hidden");currentStudentId = null;}function printStudentDetails() {const modal = document.getElementById("student-details-modal");const originalClasses = modal.className;modal.className = "fixed inset-0 bg-white overflow-y-auto h-full w-full z-50";window.print();setTimeout(() => {modal.className = originalClasses;}, 100);}function viewFullProfile() {if (currentStudentId) {window.open("student_view.php?id=" + currentStudentId, "_blank");} else {showToast("No student selected", "warning");}}function closeModal(event) {if (event.target === event.currentTarget) {event.currentTarget.classList.add("hidden");}}function closeAllModals() {document.querySelectorAll(".modal").forEach(modal => {modal.classList.add("hidden");});}function initializeTooltips() {document.querySelectorAll("[title]").forEach(element => {element.addEventListener("mouseenter", showTooltip);element.addEventListener("mouseleave", hideTooltip);});}function showTooltip(event) {const tooltip = document.createElement("div");tooltip.className = "tooltip fixed z-50 px-2 py-1 text-xs text-white bg-gray-900 dark:bg-gray-700 rounded shadow-lg pointer-events-none";tooltip.textContent = event.target.title;event.target.dataset.originalTitle = event.target.title;event.target.removeAttribute("title");document.body.appendChild(tooltip);const rect = event.target.getBoundingClientRect();tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + "px";tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + "px";}function hideTooltip(event) {if (event.target.dataset.originalTitle) {event.target.title = event.target.dataset.originalTitle;delete event.target.dataset.originalTitle;}document.querySelectorAll(".tooltip").forEach(tooltip => tooltip.remove());};let currentEditingStudent = null;let currentEditingTable = 'students';let originalStudentData = null;let hasUnsavedChanges = false;let currentActiveTab = 'profile';window.openEditDrawer = function(studentData, table) {const existingDrawer = document.getElementById("enhancedEditDrawer");if (existingDrawer) {existingDrawer.remove();}window.currentEditingStudent = { ...studentData };window.currentEditingTable = table || "students";window.originalStudentData = { ...studentData };createEnhancedEditDrawer(studentData);requestAnimationFrame(() => {const drawer = document.getElementById("enhancedEditDrawer");if (drawer) {drawer.classList.remove("translate-x-full");drawer.querySelector(".drawer-panel").classList.remove("translate-x-full");}});document.body.style.overflow = "hidden";initializeEnhancedDrawerFeatures();setTimeout(() => {if (window.setEditEthiopianBirthDate && studentData) {window.setEditEthiopianBirthDate(studentData);}}, 100); initializeKeyboardShortcuts();showToast("Enhanced edit drawer opened - Ready for professional editing!", "success");};function createEnhancedEditDrawer(studentData) {const drawerHTML = `<div id="enhancedEditDrawer" class="fixed inset-0 z-50 flex justify-end bg-black bg-opacity-60 backdrop-blur-sm translate-x-full transition-all duration-300 ease-in-out"><div class="drawer-panel w-full max-w-3xl bg-white dark:bg-gray-900 shadow-2xl transform translate-x-full transition-all duration-300 ease-in-out overflow-hidden flex flex-col h-screen"><!-- Header with gradient and enhanced styling --><div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-500 text-white p-6 shadow-xl"><div class="flex items-center justify-between"><div class="flex items-center space-x-4"><div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><i class="fas fa-user-edit text-2xl"></i></div><div><h2 class="text-2xl font-bold">Student Profile Editor</h2><p class="text-indigo-100 text-sm flex items-center"><span class="truncate max-w-xs">${studentData.full_name || "Student Details"}</span><span class="ml-2 px-2 py-0.5 bg-white bg-opacity-20 rounded-full text-xs">ID: ${studentData.id || "N/A"}</span></p></div></div><div class="flex items-center space-x-3"><div id="saveStatusIndicator" class="flex items-center space-x-2 text-sm bg-white bg-opacity-10 px-3 py-1 rounded-full"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><span>Ready</span></div><button onclick="closeEnhancedEditDrawer()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-200"><i class="fas fa-times text-2xl"></i></button></div></div></div><!-- Enhanced Tab Navigation with Progress Indicator --><div class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6"><div class="flex items-center justify-between py-3"><nav class="flex space-x-1 overflow-x-auto"><button onclick="switchEnhancedTab('profile')" class="tab-btn-enhanced tab-btn-active py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-user-circle mr-2"></i>Profile</button><button onclick="switchEnhancedTab('academic')" class="tab-btn-enhanced py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-graduation-cap mr-2"></i>Academic</button><button onclick="switchEnhancedTab('family')" class="tab-btn-enhanced py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-users mr-2"></i>Family</button><button onclick="switchEnhancedTab('contact')" class="tab-btn-enhanced py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-address-book mr-2"></i>Contact</button><button onclick="switchEnhancedTab('additional')" class="tab-btn-enhanced py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-plus-circle mr-2"></i>Additional</button></nav><div class="hidden md:flex items-center space-x-2"><span class="text-xs text-gray-500 dark:text-gray-400">Progress:</span><div class="w-24 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"><div id="completionProgress" class="h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full" style="width: 0%"></div></div></div></div></div><!-- Content Area with Scrollable Sections --><div class="flex-1 overflow-y-auto p-6"><form id="enhancedStudentEditForm" class="space-y-8"><!-- Profile Tab --><div id="profileTab" class="tab-content-enhanced">${createEnhancedProfileTab(studentData)}</div><!-- Academic Tab --><div id="academicTab" class="tab-content-enhanced hidden">${createEnhancedAcademicTab(studentData)}</div><!-- Family Tab --><div id="familyTab" class="tab-content-enhanced hidden">${createEnhancedFamilyTab(studentData)}</div><!-- Contact Tab --><div id="contactTab" class="tab-content-enhanced hidden">${createEnhancedContactTab(studentData)}</div><!-- Additional Tab --><div id="additionalTab" class="tab-content-enhanced hidden">${createEnhancedAdditionalTab(studentData)}</div></form></div><!-- Enhanced Footer Actions --><div class="bg-gray-50 dark:bg-gray-800 p-6 border-t border-gray-200 dark:border-gray-700"><div class="flex items-center justify-between"><div class="flex items-center space-x-3"><button onclick="resetEnhancedForm()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg font-medium transition-all duration-200 flex items-center"><i class="fas fa-undo mr-2"></i>Reset</button><button onclick="previewChanges()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg font-medium transition-all duration-200 flex items-center"><i class="fas fa-eye mr-2"></i>Preview</button></div><div class="flex items-center space-x-3"><button onclick="saveEnhancedStudentChanges(false)" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center"><i class="fas fa-save mr-2"></i>Save Changes</button></div></div></div><!-- Enhanced Camera Modal --><div id="enhanced-camera-modal" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-96 shadow-2xl relative"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900 dark:text-white">Capture Photo</h3><button type="button" onclick="closeEnhancedCameraModal()" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300"><i class="fas fa-times"></i></button></div><video id="enhanced-camera-video" autoplay playsinline class="w-full h-64 bg-gray-200 dark:bg-gray-700 rounded-lg"></video><canvas id="enhanced-camera-canvas" class="hidden"></canvas><div class="flex justify-between mt-4"><button type="button" onclick="switchEnhancedCamera()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-sync-alt mr-2"></i>Switch Camera</button><button type="button" onclick="captureEnhancedPhoto()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-camera mr-2"></i>Capture</button></div></div></div><!-- Changes Preview Modal --><div id="changes-preview-modal" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900 dark:text-white">Changes Preview</h3><button type="button" onclick="closeChangesPreview()" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300"><i class="fas fa-times"></i></button></div><div id="changes-preview-content" class="space-y-4"><!-- Changes will be populated here --></div><div class="flex justify-end mt-6 pt-4 border-t border-gray-200 dark:border-gray-700"><button type="button" onclick="closeChangesPreview()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-all duration-200 mr-2">Close</button><button type="button" onclick="saveEnhancedStudentChanges()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all duration-200">Save Changes</button></div></div></div></div></div>`;document.body.insertAdjacentHTML('beforeend', drawerHTML);}function createEnhancedProfileTab(student) {return `<div class="space-y-8"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div>${createEnhancedPhotoSection(student)}</div><div class="lg:col-span-2">${createEnhancedBasicInfoSection(student)}</div></div><div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-800 p-5 rounded-2xl border border-blue-100 dark:border-gray-700"><h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white flex items-center"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Personal Information</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender</label><select name="gender" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"><option value="">Select Gender</option><option value="male"${String(student.gender).toLowerCase() === 'male' ? ' selected' : ''}>Male</option><option value="female"${String(student.gender).toLowerCase() === 'female' ? ' selected' : ''}>Female</option></select></div><div><label class="block text-gray-700 dark:text-gray-300 mb-1">የተወለዱበት ቀን (ዓ.ም) <span class="text-red-500">*</span></label><div class="grid grid-cols-1 sm:grid-cols-3 gap-2"><select id="edit_birth_year_et" name="birth_year_et" class="px-3 py-2 border rounded dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required><option value="">ዓመት</option></select><select id="edit_birth_month_et" name="birth_month_et" class="px-3 py-2 border rounded dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required><option value="">ወር</option></select><select id="edit_birth_day_et" name="birth_day_et" class="px-3 py-2 border rounded dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required><option value="">ቀን</option></select></div><!-- Hidden field to maintain compatibility with existing backend --><input type="hidden" name="birth_date" id="edit_birth_date_hidden"></div><div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Grade</label><select name="current_grade" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"><option value="">Select Grade</option>${['new','1st','2nd','3rd','4th','5th','6th','7th','8th','9th','10th','11th','12th'].map(g => `<option value="${g}"${String(student.current_grade||'')===g?' selected':''}>${g.toUpperCase()}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number</label><input type="tel" name="phone_number" value="${student.phone_number || ''}" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"></div></div></div></div>`;}function createEnhancedPhotoSection(student) {const src = student.photo_path || student.person_photo_path || '';const preview = src ? `<img id="enhanced-photo-preview" src="${src}" class="w-32 h-32 rounded-2xl object-cover ring-4 ring-indigo-200 dark:ring-indigo-900 shadow-lg" />` : `<div id="enhanced-photo-preview-ph" class="w-32 h-32 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-semibold text-xl">IMG</div>`;return `<div class="p-5 rounded-2xl bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 shadow-sm"><div class="flex flex-col items-center gap-4">${preview}<div class="w-full space-y-3"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Profile Photo</label><input type="file" name="student_photo" accept="imagelet currentEditingInstrument = null;let originalInstrumentData = null;let hasUnsavedInstrumentChanges = false;let currentInstrumentTab = 'basic';window.openInstrumentEditDrawer = function(instrumentData, table = 'instruments') {const existingDrawer = document.getElementById("instrumentEditDrawer");if (existingDrawer) {existingDrawer.remove();}window.currentEditingInstrument = { ...instrumentData };window.originalInstrumentData = { ...instrumentData };createInstrumentEditDrawer(instrumentData);requestAnimationFrame(() => {const drawer = document.getElementById("instrumentEditDrawer");if (drawer) {drawer.classList.remove("translate-x-full");drawer.querySelector(".drawer-panel").classList.remove("translate-x-full");}});document.body.style.overflow = "hidden";initializeInstrumentDrawerFeatures();initializeInstrumentKeyboardShortcuts();showToast("Instrument edit drawer opened - Ready for editing!", "success");};function createInstrumentEditDrawer(instrumentData) {const drawerHTML = `<div id="instrumentEditDrawer" class="fixed inset-0 z-50 flex justify-end bg-black bg-opacity-60 backdrop-blur-sm translate-x-full transition-all duration-300 ease-in-out"><div class="drawer-panel w-full max-w-3xl bg-white dark:bg-gray-900 shadow-2xl transform translate-x-full transition-all duration-300 ease-in-out overflow-hidden flex flex-col h-screen"><!-- Header with gradient and enhanced styling --><div class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-500 text-white p-6 shadow-xl"><div class="flex items-center justify-between"><div class="flex items-center space-x-4"><div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><i class="fas fa-music text-2xl"></i></div><div><h2 class="text-2xl font-bold">Instrument Registration Editor</h2><p class="text-purple-100 text-sm flex items-center"><span class="truncate max-w-xs">${instrumentData.full_name || "Registration Details"}</span><span class="ml-2 px-2 py-0.5 bg-white bg-opacity-20 rounded-full text-xs">${instrumentData.instrument ? getMultipleInstrumentDisplayName(instrumentData.instrument) : "N/A"}</span><span class="ml-2 px-2 py-0.5 bg-white bg-opacity-20 rounded-full text-xs">ID: ${instrumentData.id || "N/A"}</span></p></div></div><div class="flex items-center space-x-3"><div id="instrumentSaveStatusIndicator" class="flex items-center space-x-2 text-sm bg-white bg-opacity-10 px-3 py-1 rounded-full"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><span>Ready</span></div><button onclick="closeInstrumentEditDrawer()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-200"><i class="fas fa-times text-2xl"></i></button></div></div></div><!-- Enhanced Tab Navigation --><div class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6"><div class="flex items-center justify-between py-3"><nav class="flex space-x-1 overflow-x-auto"><button onclick="switchInstrumentTab('basic')" class="instrument-tab-btn instrument-tab-active py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-user-circle mr-2"></i>Basic Info</button><button onclick="switchInstrumentTab('instrument')" class="instrument-tab-btn py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-music mr-2"></i>Instrument Details</button><button onclick="switchInstrumentTab('contact')" class="instrument-tab-btn py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-address-book mr-2"></i>Contact & Address</button><button onclick="switchInstrumentTab('spiritual')" class="instrument-tab-btn py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-cross mr-2"></i>Spiritual Info</button></nav><div class="hidden md:flex items-center space-x-2"><span class="text-xs text-gray-500 dark:text-gray-400">Progress:</span><div class="w-24 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"><div id="instrumentCompletionProgress" class="h-full bg-gradient-to-r from-purple-400 to-blue-500 rounded-full" style="width: 0%"></div></div></div></div></div><!-- Content Area with Scrollable Sections --><div class="flex-1 overflow-y-auto p-6"><form id="instrumentEditForm" class="space-y-8"><!-- Basic Info Tab --><div id="basicTab" class="instrument-tab-content">${createInstrumentBasicTab(instrumentData)}</div><!-- Instrument Details Tab --><div id="instrumentTab" class="instrument-tab-content hidden">${createInstrumentDetailsTab(instrumentData)}</div><!-- Contact & Address Tab --><div id="contactTab" class="instrument-tab-content hidden">${createInstrumentContactTab(instrumentData)}</div><!-- Spiritual Info Tab --><div id="spiritualTab" class="instrument-tab-content hidden">${createInstrumentSpiritualTab(instrumentData)}</div></form></div><!-- Enhanced Footer Actions --><div class="bg-gray-50 dark:bg-gray-800 p-6 border-t border-gray-200 dark:border-gray-700"><div class="flex items-center justify-between"><div class="flex items-center space-x-3"><button onclick="resetInstrumentForm()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg font-medium transition-all duration-200 flex items-center"><i class="fas fa-undo mr-2"></i>Reset</button><button onclick="previewInstrumentChanges()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg font-medium transition-all duration-200 flex items-center"><i class="fas fa-eye mr-2"></i>Preview</button></div><div class="flex items-center space-x-3"><button onclick="saveInstrumentChanges()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center"><i class="fas fa-save mr-2"></i>Save Changes</button></div></div></div><!-- Enhanced Camera Modal --><div id="instrument-camera-modal" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-96 shadow-2xl relative"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900 dark:text-white">Capture Photo</h3><button type="button" onclick="closeInstrumentCameraModal()" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300"><i class="fas fa-times"></i></button></div><video id="instrument-camera-video" autoplay playsinline class="w-full h-64 bg-gray-200 dark:bg-gray-700 rounded-lg"></video><canvas id="instrument-camera-canvas" class="hidden"></canvas><div class="flex justify-between mt-4"><button type="button" onclick="switchInstrumentCamera()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-sync-alt mr-2"></i>Switch Camera</button><button type="button" onclick="captureInstrumentPhoto()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg transition-all duration-200 flex items-center"><i class="fas fa-camera mr-2"></i>Capture</button></div></div></div><!-- Changes Preview Modal --><div id="instrument-changes-preview-modal" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900 dark:text-white">Changes Preview</h3><button type="button" onclick="closeInstrumentChangesPreview()" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300"><i class="fas fa-times"></i></button></div><div id="instrument-changes-preview-content" class="space-y-4"><!-- Changes will be populated here --></div><div class="flex justify-end mt-6 pt-4 border-t border-gray-200 dark:border-gray-700"><button type="button" onclick="closeInstrumentChangesPreview()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-all duration-200 mr-2">Close</button><button type="button" onclick="saveInstrumentChanges()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg transition-all duration-200">Save Changes</button></div></div></div></div></div>`;document.body.insertAdjacentHTML('beforeend', drawerHTML);initializeInstrumentChangeDetection();}function createInstrumentBasicTab(instrument) {return `<div class="space-y-8"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div>${createInstrumentPhotoSection(instrument)}</div><div class="lg:col-span-2">${createInstrumentBasicInfoSection(instrument)}</div></div></div>`;}function createInstrumentPhotoSection(instrument) {const photoPath = instrument.person_photo_path || instrument.photo_path || '';return `<div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 p-5 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm"><h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center"><i class="fas fa-camera text-purple-600 mr-2"></i>Student Photo</h3><div class="flex flex-col items-center space-y-4"><div class="w-32 h-32 rounded-2xl overflow-hidden bg-gray-100 dark:bg-gray-700 border-4 border-white dark:border-gray-600 shadow-lg">${photoPath ? `<img src="${photoPath}" alt="Student photo" class="w-full h-full object-cover" id="instrumentPhotoPreview">` :`<div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500" id="instrumentPhotoPreview"><i class="fas fa-user text-4xl"></i></div>`}</div><input type="file" name="person_photo" id="instrumentPhotoInput" accept="imagelet availableColumns = {};let selectedFields = [];function initializeColumnData(columns, selected) {availableColumns = columns;selectedFields = selected;}function showColumnCustomizer() {document.getElementById("column-customizer-modal").classList.remove("hidden");populateColumnOptions();updateSelectedCount();}function closeColumnCustomizer() {document.getElementById("column-customizer-modal").classList.add("hidden");}function setupColumnEventListeners() {document.addEventListener("change", function(e) {if (e.target.classList.contains("column-checkbox")) {updateSelectedCount();}});}function updateSelectedCount() {const selected = document.querySelectorAll(".column-checkbox:checked").length;const total = document.querySelectorAll(".column-checkbox").length;const visible = document.querySelectorAll(".column-checkbox:not([style*=\"none\"])").length;const countElement = document.getElementById("selected-count");if (countElement) {countElement.textContent = selected;}const totalElement = document.getElementById("total-columns-count");const selectedElement = document.getElementById("selected-columns-count");const visibleElement = document.getElementById("visible-columns-count");if (totalElement) totalElement.textContent = total;if (selectedElement) selectedElement.textContent = selected;if (visibleElement) visibleElement.textContent = visible;}function filterColumns() {const searchTerm = document.getElementById("column-search").value.toLowerCase();const labels = document.querySelectorAll("#column-options label");labels.forEach(label => {const text = label.textContent.toLowerCase();const shouldShow = text.includes(searchTerm);label.style.display = shouldShow ? "flex" : "none";});const categories = document.querySelectorAll("[data-category]");categories.forEach(category => {const visibleColumns = category.querySelectorAll("label[style*=\"flex\"], label:not([style*=\"none\"])").length;const categoryHeader = category.previousElementSibling;if (categoryHeader && categoryHeader.querySelector("h4")) {categoryHeader.style.display = visibleColumns > 0 ? "block" : "none";}category.style.display = visibleColumns > 0 ? "grid" : "none";});updateSelectedCount();}function saveCurrentAsPreset() {const selectedColumns = [];document.querySelectorAll(".column-checkbox:checked").forEach(checkbox => {selectedColumns.push(checkbox.value);});if (selectedColumns.length === 0) {showToast("Please select at least one column", "warning");return;}const presetName = prompt("Enter a name for this column preset:");if (!presetName) return;const presets = JSON.parse(localStorage.getItem("columnPresets") || "{}");presets[currentView + "_" + presetName] = {columns: selectedColumns,created: new Date().toISOString(),view: currentView};localStorage.setItem("columnPresets", JSON.stringify(presets));showToast("Preset \"" + presetName + "\" saved successfully", "success");}function populateColumnOptions() {const container = document.getElementById("column-options");const urlParams = new URLSearchParams(window.location.search);const currentColumns = urlParams.get('columns') ? urlParams.get('columns').split(',') : selectedFields;const columnCategories = {'basic': {label: 'Basic Information',columns: ['photo_path', 'full_name', 'christian_name', 'gender', 'birth_date', 'current_grade', 'phone_number', 'created_at']},'education': {label: 'Education Details',columns: ['school_year_start', 'regular_school_name', 'regular_school_grade', 'education_level', 'field_of_study']},'location': {label: 'Location & Address',columns: ['sub_city', 'district', 'specific_area', 'house_number', 'living_with']},'emergency': {label: 'Emergency Contacts',columns: ['emergency_name', 'emergency_phone', 'emergency_alt_phone', 'emergency_address']},'spiritual': {label: 'Spiritual Information',columns: ['has_spiritual_father', 'spiritual_father_name', 'spiritual_father_phone', 'spiritual_father_church']},'family': {label: 'Family Information',columns: ['father_full_name', 'father_phone', 'father_occupation', 'mother_full_name', 'mother_phone', 'mother_occupation', 'guardian_full_name', 'guardian_phone', 'guardian_occupation']},'additional': {label: 'Additional Information',columns: ['special_interests', 'siblings_in_school', 'physical_disability', 'weak_side', 'transferred_from_other_school', 'came_from_other_religion']}};let html = `<div class="space-y-6"><div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-600"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">Column Categories</span><div class="flex space-x-2"><button type="button" onclick="selectAllColumns()" class="px-3 py-1 text-xs bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors">Select All</button><button type="button" onclick="deselectAllColumns()" class="px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Deselect All</button></div></div>`;Object.entries(columnCategories).forEach(([categoryKey, category]) => {const categoryColumns = category.columns.filter(col => availableColumns.hasOwnProperty(col));if (categoryColumns.length === 0) return;html += `<div class="space-y-3"><div class="flex items-center justify-between"><h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200">${category.label}</h4><button type="button" onclick="toggleCategoryColumns('${categoryKey}')" class="text-xs text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200">Toggle All</button></div><div class="grid grid-cols-1 gap-2" data-category="${categoryKey}">`;categoryColumns.forEach(columnKey => {const checked = currentColumns.includes(columnKey) ? 'checked' : '';const label = availableColumns[columnKey] || columnKey;html += `<label class="flex items-center space-x-3 p-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors text-sm"><input type="checkbox" value="${columnKey}" ${checked} class="column-checkbox rounded border-gray-300 text-primary-600 focus:ring-primary-500 text-sm"><span class="text-gray-700 dark:text-gray-300">${label}</span></label>`;});html += `</div></div>`;});const categorizedColumns = Object.values(columnCategories).flatMap(cat => cat.columns);const remainingColumns = Object.keys(availableColumns).filter(col => !categorizedColumns.includes(col));if (remainingColumns.length > 0) {html += `<div class="space-y-2"><h4 class="text-xs font-semibold text-gray-800 dark:text-gray-200">Other Fields</h4><div class="grid grid-cols-1 gap-1">`;remainingColumns.forEach(columnKey => {const checked = currentColumns.includes(columnKey) ? 'checked' : '';const label = availableColumns[columnKey] || columnKey;html += `<label class="flex items-center space-x-3 p-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors text-sm"><input type="checkbox" value="${columnKey}" ${checked} class="column-checkbox rounded border-gray-300 text-primary-600 focus:ring-primary-500 text-sm"><span class="text-gray-700 dark:text-gray-300">${label}</span></label>`;});html += `</div></div>`;}html += `</div>`;container.innerHTML = html;setTimeout(() => {updateSelectedCount();}, 100);}function applyColumnSettings() {const selectedColumns = [];document.querySelectorAll('.column-checkbox:checked').forEach(checkbox => {selectedColumns.push(checkbox.value);});if (selectedColumns.length === 0) {showToast('Please select at least one column', 'warning');return;}const formData = new FormData();formData.append('view', currentView);formData.append('columns', selectedColumns.join(','));fetch('save_column_prefs.php', {method: 'POST',body: formData}).then(response => response.json()).then(data => {if (data.success) {const url = new URL(window.location);url.searchParams.set('columns', selectedColumns.join(','));window.location.href = url.toString();} else {showToast('Error saving column preferences', 'error');}}).catch(error => {console.error('Error:', error);showToast('Error saving column preferences', 'error');});}function selectAllColumns() {document.querySelectorAll('.column-checkbox').forEach(checkbox => {checkbox.checked = true;});updateSelectedCount();}function deselectAllColumns() {document.querySelectorAll('.column-checkbox').forEach(checkbox => {checkbox.checked = false;});updateSelectedCount();}function toggleCategoryColumns(category) {const categoryContainer = document.querySelector(`[data-category="${category}"]`);if (!categoryContainer) return;const checkboxes = categoryContainer.querySelectorAll('.column-checkbox');const allChecked = Array.from(checkboxes).every(cb => cb.checked);checkboxes.forEach(checkbox => {checkbox.checked = !allChecked;});updateSelectedCount();}function resetToDefaults() {const defaultColumns = {'all': ['photo_path', 'full_name', 'gender', 'birth_date', 'current_grade', 'phone_number'],'youth': ['photo_path', 'full_name', 'gender', 'birth_date', 'current_grade', 'phone_number', 'field_of_study'],'under': ['photo_path', 'full_name', 'gender', 'birth_date', 'current_grade', 'sub_city', 'district', 'phone_number'],'instrument': ['photo_path', 'full_name', 'gender', 'instrument', 'phone_number', 'status']};const currentDefaults = defaultColumns[currentView] || defaultColumns['all'];document.querySelectorAll('.column-checkbox').forEach(checkbox => {checkbox.checked = currentDefaults.includes(checkbox.value);});updateSelectedCount();}function saveAsPreset() {const selectedColumns = [];document.querySelectorAll('.column-checkbox:checked').forEach(checkbox => {selectedColumns.push(checkbox.value);});if (selectedColumns.length === 0) {showToast('Please select at least one column', 'warning');return;}const presetName = prompt('Enter a name for this column preset:');if (!presetName) return;const presets = JSON.parse(localStorage.getItem('columnPresets') || '{}');presets[currentView + '_' + presetName] = selectedColumns;localStorage.setItem('columnPresets', JSON.stringify(presets));showToast(`Preset "${presetName}" saved successfully`, 'success');}function loadPreset() {const presets = JSON.parse(localStorage.getItem('columnPresets') || '{}');const currentViewPresets = Object.keys(presets).filter(key => key.startsWith(currentView + '_'));if (currentViewPresets.length === 0) {showToast('No saved presets found', 'info');return;}const presetNames = currentViewPresets.map(key => key.replace(currentView + '_', ''));const selectedPreset = prompt('Available presets:\n' + presetNames.join('\n') + '\n\nEnter preset name to load:');if (!selectedPreset) return;const presetKey = currentView + '_' + selectedPreset;const presetColumns = presets[presetKey];if (!presetColumns) {showToast('Preset not found', 'error');return;}document.querySelectorAll('.column-checkbox').forEach(checkbox => {checkbox.checked = presetColumns.includes(checkbox.value);});showToast(`Preset "${selectedPreset}" loaded successfully`, 'success');}document.addEventListener("DOMContentLoaded", function() {setupColumnEventListeners();});;function initializeFilterEthiopianCalendar() {console.log('Starting Ethiopian calendar filter initialization...');const fromYearSel = document.getElementById('birth_from_year');const fromMonthSel = document.getElementById('birth_from_month');const fromDaySel = document.getElementById('birth_from_day');const fromHidden = document.getElementById('date_from_hidden');const toYearSel = document.getElementById('birth_to_year');const toMonthSel = document.getElementById('birth_to_month');const toDaySel = document.getElementById('birth_to_day');const toHidden = document.getElementById('date_to_hidden');if (!fromYearSel || !fromMonthSel || !fromDaySel || !toYearSel || !toMonthSel || !toDaySel) {console.log('Ethiopian calendar filter elements not found, skipping initialization');return;}console.log('All filter elements found, proceeding with initialization');const monthNames = ['መስከረም', 'ጥቅምት', 'ሕዳር', 'ታህሳስ', 'ጥር', 'የካቲት', 'መጋቢት', 'ሚያዝያ', 'ግንቦት', 'ሰኔ', 'ሐምሌ', 'ነሐሴ', 'ጳጉሜ'];function getCurrentEthiopianYear() {const today = new Date();const gYear = today.getFullYear();const gMonth = today.getMonth() + 1;const gDay = today.getDate();let eYear = gYear - 8;if (gMonth > 9 || (gMonth === 9 && gDay >= 11)) eYear = gYear - 7;return eYear;}function isEthiopianLeapYear(eYear) {return eYear % 4 === 3;}function daysInEthiopianMonth(eYear, eMonth) {if (eMonth >= 1 && eMonth <= 12) return 30;return isEthiopianLeapYear(eYear) ? 6 : 5; }function populateFromYears() {const current = getCurrentEthiopianYear();const min = current - 40;fromYearSel.innerHTML = '<option value="">ዓመት</option>';for (let y = current; y >= min; y--) {const opt = document.createElement('option');opt.value = String(y);opt.textContent = y;fromYearSel.appendChild(opt);}console.log('Populated FROM years, count:', fromYearSel.options.length);}function populateToYears() {const current = getCurrentEthiopianYear();const min = current - 40;toYearSel.innerHTML = '<option value="">ዓመት</option>';for (let y = current; y >= min; y--) {const opt = document.createElement('option');opt.value = String(y);opt.textContent = y;toYearSel.appendChild(opt);}console.log('Populated TO years, count:', toYearSel.options.length);}function populateFromMonths() {fromMonthSel.innerHTML = '<option value="">ወር</option>';monthNames.forEach((name, idx) => {const opt = document.createElement('option');opt.value = String(idx + 1);opt.textContent = name;fromMonthSel.appendChild(opt);});console.log('Populated FROM months, count:', fromMonthSel.options.length);}function populateToMonths() {toMonthSel.innerHTML = '<option value="">ወር</option>';monthNames.forEach((name, idx) => {const opt = document.createElement('option');opt.value = String(idx + 1);opt.textContent = name;toMonthSel.appendChild(opt);});console.log('Populated TO months, count:', toMonthSel.options.length);}function populateFromDays() {const y = parseInt(fromYearSel.value, 10);const m = parseInt(fromMonthSel.value, 10);fromDaySel.innerHTML = '<option value="">ቀን</option>';if (!y || !m) return;const dim = daysInEthiopianMonth(y, m);for (let d = 1; d <= dim; d++) {const opt = document.createElement('option');opt.value = String(d);opt.textContent = String(d);fromDaySel.appendChild(opt);}updateFromHiddenField();}function populateToDays() {const y = parseInt(toYearSel.value, 10);const m = parseInt(toMonthSel.value, 10);toDaySel.innerHTML = '<option value="">ቀን</option>';if (!y || !m) return;const dim = daysInEthiopianMonth(y, m);for (let d = 1; d <= dim; d++) {const opt = document.createElement('option');opt.value = String(d);opt.textContent = String(d);toDaySel.appendChild(opt);}updateToHiddenField();}function updateFromHiddenField() {const y = fromYearSel.value;const m = fromMonthSel.value;const d = fromDaySel.value;if (y && m && d && fromHidden) {const formattedDate = y + '-' + String(m).padStart(2, '0') + '-' + String(d).padStart(2, '0');fromHidden.value = formattedDate;} else if (fromHidden) {fromHidden.value = '';}}function updateToHiddenField() {const y = toYearSel.value;const m = toMonthSel.value;const d = toDaySel.value;if (y && m && d && toHidden) {const formattedDate = y + '-' + String(m).padStart(2, '0') + '-' + String(d).padStart(2, '0');toHidden.value = formattedDate;} else if (toHidden) {toHidden.value = '';}}fromYearSel.addEventListener('change', function() { populateFromDays(); updateFromHiddenField();});fromMonthSel.addEventListener('change', function() { populateFromDays(); updateFromHiddenField();});fromDaySel.addEventListener('change', function() {updateFromHiddenField();});toYearSel.addEventListener('change', function() { populateToDays(); updateToHiddenField();});toMonthSel.addEventListener('change', function() { populateToDays(); updateToHiddenField();});toDaySel.addEventListener('change', function() {updateToHiddenField();});populateFromYears();populateFromMonths();populateToYears();populateToMonths();const urlParams = new URLSearchParams(window.location.search);const dateFrom = urlParams.get('date_from');const dateTo = urlParams.get('date_to');if (dateFrom) {const parts = dateFrom.split('-');if (parts.length === 3) {fromYearSel.value = parts[0];fromMonthSel.value = parseInt(parts[1], 10).toString();populateFromDays();fromDaySel.value = parseInt(parts[2], 10).toString();updateFromHiddenField();}}if (dateTo) {const parts = dateTo.split('-');if (parts.length === 3) {toYearSel.value = parts[0];toMonthSel.value = parseInt(parts[1], 10).toString();populateToDays();toDaySel.value = parseInt(parts[2], 10).toString();updateToHiddenField();}}console.log('Ethiopian calendar filter initialization complete!');}document.addEventListener('DOMContentLoaded', function() {console.log('DOM loaded, attempting Ethiopian calendar initialization...');initializeFilterEthiopianCalendar();setTimeout(function() {console.log('Retry 1: Ethiopian calendar initialization...');initializeFilterEthiopianCalendar();}, 250);setTimeout(function() {console.log('Retry 2: Ethiopian calendar initialization...');initializeFilterEthiopianCalendar();}, 1000);});window.addEventListener('load', function() {console.log('Window loaded, final Ethiopian calendar initialization attempt...');setTimeout(function() {initializeFilterEthiopianCalendar();}, 100);});;